<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡πÄ‡∏Å‡∏°‡∏¢‡∏¥‡∏á‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤: ‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏â‡∏±‡∏ô‡∏ó‡πå ‡πë‡πë</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&family=Prompt:wght@600&display=swap" rel="stylesheet">
    <style>
        /* === CSS Styling: ‡∏ò‡∏µ‡∏°‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå === */
        :root {
            --gold: #FFD700;
            --gold-light: #FFF8DC;
            --sky-blue: #87CEEB;
            --deep-blue: #0077BE;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Prompt', sans-serif;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%);
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI Overlay */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Mission Panel */
        .mission-panel {
            background: rgba(255, 255, 255, 0.9);
            margin: 10px auto;
            padding: 10px 20px;
            border-radius: 15px;
            border: 3px solid var(--gold);
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            pointer-events: auto;
            min-width: 300px;
        }

        .mission-title {
            color: var(--deep-blue);
            font-size: 1.2rem;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .mission-timer {
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .mission-bar {
            height: 100%;
            background: #ff4136; /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏° */
            width: 100%;
            transition: width 0.1s linear;
        }

        .score-display {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 20px;
        }

        .btn-end-game {
            position: absolute;
            top: 20px;
            right: 20px;
            pointer-events: auto;
            background: #ff4136;
            color: white;
            border: 2px solid white;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Prompt', sans-serif;
            font-size: 1rem;
        }

        /* Login & Screens */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95); /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏ß‡∏ô‡∏ß‡∏• */
            background-image: url('https://nonthaphathr.github.io/uploadimg/bgindra.png');
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            pointer-events: auto;
        }

        .screen-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            border: 4px solid var(--gold);
            max-width: 90%;
            width: 400px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        h1 {
            color: var(--deep-blue);
            margin: 0 0 20px 0;
            text-shadow: 1px 1px 0px var(--gold);
        }

        input, select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: 'Sarabun', sans-serif;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .btn {
            background: linear-gradient(45deg, var(--gold), #FFA500);
            border: none;
            padding: 12px 30px;
            font-size: 1.2rem;
            border-radius: 30px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 165, 0, 0.4);
            transition: transform 0.2s;
            width: 100%;
            margin-top: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .btn:active { transform: scale(0.95); }
        .btn-secondary { background: #ccc; color: #555; }
        .hidden { display: none !important; }

        /* Cloud Animation Decoration */
        .cloud {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            z-index: 1;
        }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div class="ui-layer hidden" id="game-ui">
        <div class="score-display">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="score-val">0</span></div>
        <button class="btn-end-game" onclick="endGame()">‡∏à‡∏ö‡πÄ‡∏Å‡∏°</button>

        <div class="mission-panel">
            <div class="mission-title">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: <span id="mission-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></div>
            <div style="display: flex; justify-content: space-around; font-size: 1.1rem;">
                <span style="color: #d32f2f;">‡∏Ñ‡∏£‡∏∏: <span id="mission-karu">0/0</span></span>
                <span style="color: #388e3c;">‡∏•‡∏´‡∏∏: <span id="mission-lahu">0/0</span></span>
            </div>
            <div class="mission-timer">
                <div class="mission-bar" id="mission-time-bar"></div>
            </div>
        </div>
    </div>

    <div id="login-screen" class="screen">
        <div class="screen-content">
            <h1>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏ä‡∏¥‡∏ï</h1>
            <input type="text" id="p-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            <div style="display: flex; gap: 10px;">
                <input type="number" id="p-number" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà">
                <input type="text" id="p-class" placeholder="‡∏ä‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 6/1)">
            </div>
            <button class="btn" onclick="submitRegistration()">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ</button>
            <button class="btn btn-secondary" onclick="startGuest()">‡∏ó‡∏î‡∏•‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)</button>
        </div>
    </div>

    <div id="intro-screen" class="screen hidden">
        <div class="screen-content">
            <h2>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì <span id="display-name" style="color:var(--deep-blue)"></span></h2>
            <p>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ ‡∏¢‡∏¥‡∏á‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î<br>‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î!</p>
            <hr>
            <p style="font-size: 0.9rem; color: #666;">
                <b>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</b><br>
                ‡∏Ñ‡∏£‡∏∏ = ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏´‡∏ô‡∏±‡∏Å/‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏™‡∏∞‡∏Å‡∏î/‡∏™‡∏£‡∏∞‡∏¢‡∏≤‡∏ß<br>
                ‡∏•‡∏´‡∏∏ = ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ö‡∏≤/‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏™‡∏∞‡∏Å‡∏î/‡∏™‡∏£‡∏∞‡∏™‡∏±‡πâ‡∏ô
            </p>
            <button class="btn" onclick="startGame()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à!</button>
        </div>
    </div>

    <div id="game-over-screen" class="screen hidden">
        <div class="screen-content">
            <h1 style="color: var(--deep-blue);">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô</h1>
            <p>‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: <span id="end-name"></span></p>
            <div style="font-size: 3rem; color: var(--gold); font-weight: bold; margin: 10px 0;">
                <span id="end-score">0</span>
            </div>
            <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</p>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="resetGame()">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
            </div>
        </div>
    </div>
</div>

<script>
    /* === 1. Configuration & Assets === */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏≤‡∏î Canvas ‡πÅ‡∏ö‡∏ö Fullscreen
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå
    const KARU_WORDS = ['‡∏Å‡∏≤‡∏°', '‡∏Å‡∏≤‡∏ô', '‡∏ö‡∏≤‡∏ó', '‡πÇ‡∏•‡∏Å', '‡∏ò‡∏£‡∏£‡∏°', '‡∏°‡∏≤‡∏£', '‡∏Å‡∏≤‡∏•', '‡∏ò‡∏≤‡∏ï‡∏∏', '‡∏ô‡∏≤‡∏Ñ', '‡∏£‡∏≤‡∏ä', '‡πÇ‡∏ó‡∏©', '‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', '‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥', '‡∏†‡∏û', '‡∏û‡∏±‡∏Å‡∏ï‡∏£‡πå', '‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏™‡∏π‡∏£‡∏¢‡πå'];
    const LAHU_WORDS = ['‡∏§‡∏î‡∏¥', '‡∏™‡∏∏‡∏£‡∏∞', '‡∏ô‡∏∞', '‡∏ï‡∏∞', '‡∏•‡∏∞', '‡∏ß‡∏∞', '‡∏£‡∏∞', '‡∏Å‡πá', '‡∏î‡∏µ', '‡∏à‡∏∞', '‡∏õ‡∏∞', '‡∏ó‡∏¥', '‡∏û‡∏∏', '‡∏ò‡∏∏', '‡∏™‡∏¥', '‡∏°‡∏¥', '‡∏ô‡∏∏', '‡∏•‡∏∏'];

    // ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß)
    const ASSETS = {
        bg: 'https://nonthaphathr.github.io/uploadimg/bgindra.png',
        indraIdle: 'https://nonthaphathr.github.io/uploadimg/indraremove1.png',
        indraThrow: 'https://nonthaphathr.github.io/uploadimg/indraremove2.png', // ‡∏ó‡πà‡∏≤‡πÄ‡∏Ç‡∏ß‡∏µ‡πâ‡∏¢‡∏á (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)
        lightning: 'https://nonthaphathr.github.io/uploadimg/thunderremove1.png', // ‡∏Å‡∏£‡∏∞‡∏™‡∏∏‡∏ô‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)
        itemBox: 'https://cdn-icons-png.flaticon.com/512/1139/1139982.png' // ‡∏£‡∏π‡∏õ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç (‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏£‡∏µ)
    };

    const images = {};
    let imagesLoaded = 0;
    function loadImages(cb) {
        const keys = Object.keys(ASSETS);
        keys.forEach(k => {
            const img = new Image();
            img.src = ASSETS[k];
            img.onload = () => {
                imagesLoaded++;
                if(imagesLoaded === keys.length) cb();
            };
            images[k] = img;
        });
    }

    /* === 2. Game Variables === */
    let gameState = 'login'; // login, intro, playing, gameover
    let score = 0;
    let playerData = { name: 'Guest', number: '', class: '' };
    
    // Arrays
    let projectiles = [];
    let enemies = [];
    let particles = [];
    let items = []; // New: Items

    // Player
    let player = {
        x: 0, y: 0, 
        w: 0, h: 0, // dynamic size
        angle: -Math.PI/2,
        isThrowing: false,
        throwTimer: 0
    };

    // Mission System
    let mission = {
        active: false,
        reqKaru: 0,
        reqLahu: 0,
        gotKaru: 0,
        gotLahu: 0,
        maxTime: 0,
        timeLeft: 0
    };

    // Input
    let mouseX = 0, mouseY = 0;

    /* === 3. Game Logic Classes === */

    class Projectile {
        constructor(x, y, angle) {
            this.x = x;
            this.y = y;
            this.speed = canvas.height * 0.015; // Speed relative to screen height
            this.vx = Math.cos(angle) * this.speed;
            this.vy = Math.sin(angle) * this.speed;
            this.active = true;
            this.angle = angle;
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            if (this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height) this.active = false;
        }
        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.angle + Math.PI/2);
            // ‡∏ß‡∏≤‡∏î‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏≠‡∏î‡∏µ‡πÜ
            const size = canvas.width * 0.05; 
            ctx.drawImage(images.lightning, -size/2, -size, size, size*2);
            ctx.restore();
        }
    }

    class Enemy {
        constructor() {
            this.radius = canvas.width * 0.04; // Responsive size
            this.x = Math.random() * (canvas.width - this.radius*2) + this.radius;
            this.y = -50;
            this.speed = (canvas.height * 0.002) + (Math.random() * (canvas.height * 0.003));
            
            // ‡∏™‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            this.type = Math.random() < 0.5 ? 'karu' : 'lahu';
            if (this.type === 'karu') {
                this.word = KARU_WORDS[Math.floor(Math.random() * KARU_WORDS.length)];
                this.color = '#ff4136'; // Red
            } else {
                this.word = LAHU_WORDS[Math.floor(Math.random() * LAHU_WORDS.length)];
                this.color = '#2ecc40'; // Green
            }
            this.active = true;
        }
        update() {
            this.y += this.speed;
            if (this.y > canvas.height + 50) this.active = false;
        }
        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
            ctx.fillStyle = this.color;
            ctx.fill();
            ctx.strokeStyle = "white";
            ctx.lineWidth = 3;
            ctx.stroke();
            
            ctx.fillStyle = "white";
            ctx.font = `bold ${this.radius}px Sarabun`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(this.word, this.x, this.y);
        }
    }

    class Item {
        constructor() {
            this.x = Math.random() * (canvas.width - 100) + 50;
            this.y = -50;
            this.size = canvas.width * 0.06;
            this.speed = canvas.height * 0.003;
            // Types: time (‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤), score (‡∏î‡∏≤‡∏ß), bomb (‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î)
            const r = Math.random();
            if(r < 0.4) this.type = 'time';      // 40%
            else if(r < 0.8) this.type = 'score'; // 40%
            else this.type = 'bomb';              // 20%
            this.active = true;
            this.angle = 0;
        }
        update() {
            this.y += this.speed;
            this.angle += 0.05;
            if(this.y > canvas.height + 50) this.active = false;
        }
        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.angle); // ‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏¥‡πâ‡∏á‡πÜ
            
            // ‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡∏°
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(0,0, this.size/2, 0, Math.PI*2);
            ctx.fill();
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 3;
            ctx.stroke();

            // ‡∏ß‡∏≤‡∏î‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå
            ctx.font = `${this.size/1.5}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            if(this.type === 'time') ctx.fillText('‚è≥', 0, 2);
            else if(this.type === 'score') ctx.fillText('‚≠ê', 0, 2);
            else ctx.fillText('üí£', 0, 2);

            ctx.restore();
        }
    }

    class TextEffect {
        constructor(text, x, y, color) {
            this.text = text;
            this.x = x;
            this.y = y;
            this.color = color;
            this.life = 1.0;
            this.vy = -2;
        }
        update() {
            this.y += this.vy;
            this.life -= 0.02;
        }
        draw() {
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.fillStyle = this.color;
            ctx.font = "bold 30px Prompt";
            ctx.fillText(this.text, this.x, this.y);
            ctx.globalAlpha = 1.0;
        }
    }

    /* === 4. Main System Functions === */

    function submitRegistration() {
        const name = document.getElementById('p-name').value;
        const num = document.getElementById('p-number').value;
        const cls = document.getElementById('p-class').value;

        if(!name) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠"); return; }
        
        playerData = { name, number: num, class: cls };
        document.getElementById('display-name').innerText = name;
        
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('intro-screen').classList.remove('hidden');
    }

    function startGuest() {
        playerData = { name: '‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°', number: '-', class: '-' };
        document.getElementById('display-name').innerText = '‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°';
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('intro-screen').classList.remove('hidden');
    }

    function startGame() {
        document.getElementById('intro-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('game-ui').classList.remove('hidden');
        
        resizeCanvas();
        gameState = 'playing';
        score = 0;
        
        // Reset Arrays
        projectiles = [];
        enemies = [];
        items = [];
        particles = []; // Reuse for text effects

        generateMission();
        gameLoop();
    }

    function generateMission() {
        // ‡∏™‡∏∏‡πà‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à
        const count = Math.floor(Math.random() * 3) + 3; // 3-5 ‡∏Ñ‡∏≥‡∏£‡∏ß‡∏°
        const karu = Math.floor(Math.random() * (count + 1));
        const lahu = count - karu;
        
        // ‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥ (‡∏Ñ‡∏≥‡∏•‡∏∞ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
        const time = count * 5;

        mission = {
            active: true,
            reqKaru: karu,
            reqLahu: lahu,
            gotKaru: 0,
            gotLahu: 0,
            maxTime: time,
            timeLeft: time
        };
        updateMissionUI();
    }

    function updateMissionUI() {
        const title = `‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ‡∏¢‡∏¥‡∏á‡∏Ñ‡∏£‡∏∏ ${mission.reqKaru} | ‡∏•‡∏´‡∏∏ ${mission.reqLahu}`;
        document.getElementById('mission-text').innerText = title;
        document.getElementById('mission-karu').innerText = `${mission.gotKaru}/${mission.reqKaru}`;
        document.getElementById('mission-lahu').innerText = `${mission.gotLahu}/${mission.reqLahu}`;
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        if (mission.gotKaru >= mission.reqKaru && mission.gotLahu >= mission.reqLahu) {
            missionSuccess();
        }
    }

    function missionSuccess() {
        score += 50; // Bonus
        particles.push(new TextEffect("‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! +50", canvas.width/2, canvas.height/2, "#FFD700"));
        generateMission();
    }

    function missionFail() {
        score = Math.max(0, score - 20); // Penalty
        particles.push(new TextEffect("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤! -20", canvas.width/2, canvas.height/2, "#ff4136"));
        generateMission(); // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡∏°‡πà
    }

    function endGame() {
        gameState = 'gameover';
        document.getElementById('game-ui').classList.add('hidden');
        document.getElementById('end-name').innerText = playerData.name;
        document.getElementById('end-score').innerText = score;
        document.getElementById('game-over-screen').classList.remove('hidden');
    }

    function resetGame() {
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('intro-screen').classList.remove('hidden');
    }

    /* === 5. Game Loop & Rendering === */

    let lastTime = 0;
    let spawnTimer = 0;
    
    function gameLoop(timestamp) {
        if (gameState !== 'playing') return;
        
        const dt = (timestamp - lastTime) / 1000;
        lastTime = timestamp;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. Draw Background
        if(images.bg) {
            // Draw BG covering screen
            const scale = Math.max(canvas.width / images.bg.width, canvas.height / images.bg.height);
            const x = (canvas.width / 2) - (images.bg.width / 2) * scale;
            const y = (canvas.height / 2) - (images.bg.height / 2) * scale;
            ctx.drawImage(images.bg, x, y, images.bg.width * scale, images.bg.height * scale);
        }

        // 2. Manage Mission Timer
        if(mission.active) {
            mission.timeLeft -= dt || 0.016;
            
            // Update Timer Bar Color and Width
            const pct = (mission.timeLeft / mission.maxTime) * 100;
            const bar = document.getElementById('mission-time-bar');
            bar.style.width = pct + '%';
            if(pct < 30) bar.style.background = '#ff0000';
            else bar.style.background = '#00f2fe';

            if(mission.timeLeft <= 0) {
                missionFail();
            }
        }

        // 3. Spawning
        if(timestamp - spawnTimer > 1000) { // ‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥ (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)
            // Spawn Enemy
            if(Math.random() < 0.8) enemies.push(new Enemy());
            // Spawn Item (Rare)
            if(Math.random() < 0.15) items.push(new Item());
            
            spawnTimer = timestamp;
        }

        // 4. Update & Draw Entities
        
        // --- Player ---
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏£‡∏∞‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πå‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏≠
        const pSize = Math.min(canvas.width, canvas.height) * 0.25; // ‡∏Ç‡∏ô‡∏≤‡∏î 25% ‡∏Ç‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏±‡πâ‡∏ô
        player.w = pSize;
        player.h = pSize; // ‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏à‡∏±‡∏ï‡∏∏‡∏£‡∏±‡∏™‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
        player.x = canvas.width / 2;
        player.y = canvas.height - (player.h / 1.5);

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡πÄ‡∏°‡∏≤‡∏™‡πå
        const dx = mouseX - player.x;
        const dy = mouseY - (player.y - 50);
        player.angle = Math.atan2(dy, dx);

        // Animation logic
        if(player.isThrowing && Date.now() - player.throwTimer > 300) {
            player.isThrowing = false;
        }
        const pImg = player.isThrowing ? images.indraThrow : images.indraIdle;
        // ‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô (Aspect Ratio)
        if(pImg) {
            const aspect = pImg.width / pImg.height;
            const drawH = player.h;
            const drawW = player.h * aspect;
            ctx.drawImage(pImg, player.x - drawW/2, player.y - drawH/2, drawW, drawH);
        }

        // --- Projectiles ---
        projectiles.forEach(p => { p.update(); p.draw(); });
        projectiles = projectiles.filter(p => p.active);

        // --- Enemies ---
        enemies.forEach(e => { e.update(); e.draw(); });
        enemies = enemies.filter(e => e.active);

        // --- Items ---
        items.forEach(i => { i.update(); i.draw(); });
        items = items.filter(i => i.active);

        // --- Effects ---
        particles.forEach(p => { p.update(); p.draw(); });
        particles = particles.filter(p => p.life > 0);

        // 5. Collision Detection
        
        // Projectile vs Enemy
        projectiles.forEach(p => {
            enemies.forEach(e => {
                if(!p.active || !e.active) return;
                const dist = Math.hypot(p.x - e.x, p.y - e.y);
                if(dist < e.radius + 20) {
                    p.active = false;
                    e.active = false;
                    handleHit(e);
                }
            });
            // Projectile vs Item
            items.forEach(i => {
                if(!p.active || !i.active) return;
                const dist = Math.hypot(p.x - i.x, p.y - i.y);
                if(dist < i.size + 20) {
                    p.active = false;
                    i.active = false;
                    handleItem(i);
                }
            });
        });

        document.getElementById('score-val').innerText = score;
        requestAnimationFrame(gameLoop);
    }

    function handleHit(enemy) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏¢‡∏¥‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÑ‡∏´‡∏°
        let useful = false;
        if(enemy.type === 'karu') {
            if(mission.gotKaru < mission.reqKaru) {
                mission.gotKaru++;
                useful = true;
            }
        } else {
            if(mission.gotLahu < mission.reqLahu) {
                mission.gotLahu++;
                useful = true;
            }
        }

        if(useful) {
            score += 10;
            particles.push(new TextEffect("+10", enemy.x, enemy.y, "#fff"));
        } else {
            // ‡∏¢‡∏¥‡∏á‡πÄ‡∏Å‡∏¥‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏¥‡∏á‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÑ‡∏°‡πà‡∏•‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö
            score += 1; // ‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢
            particles.push(new TextEffect("‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß!", enemy.x, enemy.y, "#ccc"));
        }
        updateMissionUI();
    }

    function handleItem(item) {
        if(item.type === 'time') {
            mission.timeLeft = Math.min(mission.timeLeft + 10, mission.maxTime);
            particles.push(new TextEffect("‡πÄ‡∏ß‡∏•‡∏≤ +10s", item.x, item.y, "#87CEEB"));
        } else if (item.type === 'score') {
            score += 30;
            particles.push(new TextEffect("‡πÇ‡∏ö‡∏ô‡∏±‡∏™ +30", item.x, item.y, "#FFD700"));
        } else if (item.type === 'bomb') {
            score = Math.max(0, score - 30);
            particles.push(new TextEffect("‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î! -30", item.x, item.y, "#ff4136"));
        }
    }

    /* === 6. Inputs === */
    window.addEventListener('mousemove', e => { mouseX = e.clientX; mouseY = e.clientY; });
    window.addEventListener('touchmove', e => { 
        mouseX = e.touches[0].clientX; mouseY = e.touches[0].clientY; 
    });
    
    function shoot(e) {
        if(gameState !== 'playing') return;
        if(e.target.tagName === 'BUTTON') return; // Don't shoot if clicking buttons

        player.isThrowing = true;
        player.throwTimer = Date.now();
        
        // ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡∏¥‡∏á (‡∏°‡∏∑‡∏≠)
        projectiles.push(new Projectile(player.x, player.y - 50, player.angle));
    }
    window.addEventListener('mousedown', shoot);
    window.addEventListener('touchstart', shoot);

    /* === 7. Start === */
    loadImages(() => {
        // Ready
        console.log("Images Loaded");
    });

</script>
</body>
</html>
